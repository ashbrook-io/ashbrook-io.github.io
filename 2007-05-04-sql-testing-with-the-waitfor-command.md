---
layout: post
title: SQL Testing with the WAITFOR Command
---

<div class="Section1">  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt">The WAITFOR command isn’t exactly new. But, I don’t really use it much. I did however recently have a desire to do some duration testing that wasn’t something akin to ‘insert 100000 rows into a table and see if stuff slows down.’ I wanted to simulate say a couple of transactions a second for a short period of time. Just a few minutes, really. I probably would have turned to writing some sort of mini test application for c# or writing a unit test that had a loop in vs. with a delay in it. Something like that. Fortunately, for me, I had recently perused and article about SQL2005 that had come up on my search for bulk importing…. another subject I intend to blog about soon. =P</span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt"> </span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt">This article was pretty old and spoke to the new changes in Yukon aka SQL2005 and one of the new enhancements was the WAITFOR command.</span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt"> </span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt">I’m just going to cut and paste from the <a href="http://msdn.microsoft.com/msdnmag/issues/04/02/TSQLinYukon/default.aspx">MSDN article</a> here<a name="S3"></a>. If you ever have a simple need to test how a system works and need to simulate some simple stress like this, check it out and I’m sure you can imagine some uses. I’m a big fan of adhoc testing as something that you can do off the cuff to rule out or highlight problems. Enjoy!</span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt"> </span></font></p>  <p class="MsoNormal"><font size="2" face="Arial"><span style="font-size:10.0pt"> </span></font></p>  <p class="MsoNormal" style="margin-left:.5in"><span class="clssubhead"><font size="2" face="Arial"><span style="font-size:10.0pt">The WAITFOR Command</span></font></span></p>  <p style="margin-left:.5in"><font size="3" face="Times New Roman"><span style="font-size:12.0pt">The WAITFOR command has been enhanced in several ways in Yukon. Besides waiting for a specified duration or until a certain datetime value, you can now request to wait for a T-SQL statement to affect at least one row. You can specify that the command wait on one of the following statements: SELECT, INSERT, UPDATE, DELETE, or RECEIVE. The first four are self-explanatory; RECEIVE refers to receiving a message from a queue. You can optionally specify a timeout if you want to stop waiting after your specified number of milliseconds. The syntax of the WAITFOR command is: </span></font></p>  <font size="2" face="Courier New"><span style="font-size:10.0pt">WAITFOR(&lt;statement&gt;) [,TIMEOUT &lt;timeout_value&gt;]</span></font>  <p style="margin-left:.5in"><font size="3" face="Times New Roman"><span style="font-size:12.0pt">Another T-SQL enhancement in Yukon allows you to return output from Data Manipulation Language (DML) statements other than SELECT (INSERT, UPDATE, DELETE). A new OUTPUT clause allows you to request that the old/new images of the columns be returned by referring to the INSERTED and DELETED tables, similar to the way you refer to them in triggers. You can even specify an INTO clause and direct the output to a table variable. Another enhancement lets you specify the READPAST hint with modifying statements, allowing you to skip locked rows.</span></font></p>  <p style="margin-left:.5in"><font size="3" face="Times New Roman"><span style="font-size:12.0pt">An example of using the aforementioned enhancements is to have several processes waiting for a DELETE statement to delete at least one row from a table, directing the output to a table variable, with each processing different portions of the data in parallel. To witness this, create the following MsgQueue table: </span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">USE</span></font><font face="Courier New"><span style="font-family: &quot;Courier New&quot;"> tempdb</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">CREATE</span></font><font face="Courier New"><span style="font-family:&quot;Courier New&quot;"> <font color="blue"><span style="color:blue">TABLE</span></font> MsgQueue</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="gray" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:gray">(</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">  msgid   <font color="blue"><span style="color:blue">INT</span></font>         <font color="gray"><span style="color:gray">NOT</span></font> <font color="gray"><span style="color:gray">NULL</span></font> <font color="blue"><span style="color:blue">IDENTITY</span></font> <font color="blue"><span style="color:blue">PRIMARY</span></font> <font color="blue"><span style="color:blue">KEY</span></font><font color="gray"><span style="color:gray">,</span></font></span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">  msgdata <font color="blue"><span style="color:blue">VARCHAR</span></font><font color="gray"><span style="color:gray">(</span></font>15<font color="gray"><span style="color:gray">)</span></font> <font color="gray"><span style="color:gray">NOT</span></font> <font color="gray"><span style="color:gray">NULL</span></font></span></font></p>  <font size="2" color="gray" face="Courier New"><span style="font-size:10.0pt;color:gray">)</span></font><font size="2" face="Courier New"><span style="font-size:10.0pt"> </span></font>  <p class="MsoNormal" style="margin-left:.5in"><font size="2" face="Arial"><span style="font-size:10.0pt">Open one or more connections and run the following code in each to periodically insert new messages into the table: </span></font></p>  <p class="MsoNormal" style="margin-left:.5in"><font size="2" face="Arial"><span style="font-size:10.0pt"> </span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">SET</span></font><font face="Courier New"><span style="font-family: &quot;Courier New&quot;"> <font color="blue"><span style="color:blue">NOCOUNT</span></font> <font color="blue"><span style="color:blue">ON</span></font></span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">USE</span></font><font face="Courier New"><span style="font-family: &quot;Courier New&quot;"> tempdb</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> </span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">WHILE</span></font><font face="Courier New"><span style="font-family: &quot;Courier New&quot;"> 1 <font color="gray"><span style="color:gray">=</span></font> 1</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">BEGIN</span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">  <font color="blue"><span style="color:blue">INSERT</span></font> <font color="blue"><span style="color:blue">INTO</span></font> MsgQueue <font color="blue"><span style="color:blue">VALUES</span></font><font color="gray"><span style="color:gray">(</span></font><font color="red"><span style="color:red">'Msg'</span></font> <font color="gray"><span style="color:gray">+</span></font></span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">    <font color="fuchsia"><span style="color:fuchsia">CAST</span></font><font color="gray"><span style="color:gray">(</span></font><font color="fuchsia"><span style="color:fuchsia">CAST</span></font><font color="gray"><span style="color:gray">(</span></font><font color="fuchsia"><span style="color:fuchsia">RAND</span></font><font color="gray"><span style="color:gray">()*</span></font>1000000000 <font color="blue"><span style="color:blue">AS</span></font> <font color="blue"><span style="color:blue">INT</span></font><font color="gray"><span style="color:gray">)</span></font> <font color="blue"><span style="color:blue">AS</span></font> <font color="blue"><span style="color:blue">VARCHAR</span></font><font color="gray"><span style="color:gray">(</span></font>10<font color="gray"><span style="color:gray">)))</span></font></span></font></p>  <p class="MsoNormal" style="margin-left:.5in;text-autospace:none"><font size="2" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">  <font color="blue"><span style="color:blue">WAITFOR</span></font> <font color="blue"><span style="color:blue">DELAY</span></font> <font color="red"><span style="color:red">'00:00:01'</span></font></span></font></p>  <p class="MsoNormal" style="margin-left:.5in"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue">END</span></font></p>  <p class="MsoNormal" style="margin-left:.5in"><font size="2" color="blue" face="Courier New"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;; color:blue"> </span></font></p>  <p class="MsoNormal" style="margin-left:.5in"><font size="2" face="Arial"><span style="font-size:10.0pt">Next you need to open several other new connections and run the code in <a href="http://msdn.microsoft.com/msdnmag/issues/04/02/TSQLinYukon/default.aspx?loc=&amp;fig=true#fig4" target="_self">Figure 4</a> in each connection to simulate processing of the newly arriving messages.</span></font></p>  </div>
