---
layout: post
published: false
title: Creating an app to search and retrieve documents on Azure
subtitle: >-
  Famous last words: This should be easy!
date: '2022-04-25'
---

After moving all of our documents into blob storage and creating an application to search the index for these documents, I discovered some gaps in my original export. I'm going to document the process to correct that here.

#### What happened?

Well, nothing terrible. I moved everything and it all worked fine. But while testing with *another* stakeholder who wasn't engaged in the original discussion, we discovered some of the index data that was not moved, was something that they used. So I decided to go back and basically rebuild the cosmos db. Not delete the existing one, but just import a new one and update the keys and links to use the new one.

Since I'm having to do this once, I don't really want to have to fiddle with the old SQL 2008 box (R1, yuck) anymore, so I wanted to go ahead and get this database just restored into a local docker container. I could put it on Azure like I did last time, but would be nice to just dev locally.

To this end, I'll refer to this page:

https://docs.microsoft.com/en-us/sql/linux/tutorial-restore-backup-in-sql-server-container?view=sql-server-ver15

Unfortunately, after reading a little bit, I see this:

![image](https://user-images.githubusercontent.com/7390156/169074369-20b76fbd-cb01-4e52-8f28-7a2005694af0.png)

I'm not a docker expert, so let's go ahead and open up docker and maybe do some updates, etc.:

Updates!

![image](https://user-images.githubusercontent.com/7390156/169074269-c0f75b76-ca91-4ba1-8ed8-aaccebe3a0e9.png)


do it!

![image](https://user-images.githubusercontent.com/7390156/169085945-0c48d8e6-1b6d-49e1-9a9c-2537ecd85184.png)

hmmm... well.... i guess we'll see?

<img width="240" alt="image" src="https://user-images.githubusercontent.com/7390156/169088699-cd2090ed-ad2b-497c-a328-044c2a916f80.png">

so, instead i did a brew upgrade docker.... ? No daemon running... ok, so reinstalling we go. =) I'm leaving this in because I like to record how many silly things you run into when you want to do some 'simple' thing.

![image](https://user-images.githubusercontent.com/7390156/169121688-95b67505-a0da-437a-8535-02d46fadc1da.png)

So now that docker is up and running and seemly all patched, let's... mount a volume or something so we can restore from backup. First will start copying this file from the server:

![image](https://user-images.githubusercontent.com/7390156/169122141-522fbac3-896f-4da2-95db-9c194fe6c087.png)


noooo...... why so slow. my connection is good and it's only 80GB. not the tiniest thing in the world, but not that big. 1.5MB/s i believe is what that works out to....

ah well, that's what's up I suppose, so we'll just see how it goes for now.

since I'm using M1 mac, I'll run the following as we need to use a different image. So.. if you're following along you'll need to install that image as well. I *believe* the command needs to be modified something like this. my bak file is in the downloads folder right now. I have a random password below, feel free to sub in your own!

```
sudo docker run -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=NdFe!Vtb' \
   --name 'sql1' -p 1401:1433 \
   -v sql1data:/var/opt/mssql \
   -v Downloads:/Users/roy/Downloads \
   -d mcr.microsoft.com/azure-sql-edge
```

after some fiddling, i seem to have my -v commands working backwards. i trashed my containers and ran this instead:

```
sudo docker run -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=NdFe!Vtb' \
   --name 'sql1' -p 1401:1433 \
   -v sql1data:/var/opt/mssql \
   -v /Users/roy/Downloads:/Downloads \
   -d mcr.microsoft.com/azure-sql-edge
```

excellent! i got prompted for access to the downloads folder this time and was able to open up the cli and navigate and see my files. if this file was smaller, i could just copy it into my docker container as noted in the ms article with `docker cp`, but i'm just going to mount that folder and restore it from there. For this I just used the steps here:

https://docs.microsoft.com/en-us/sql/linux/tutorial-restore-backup-in-sql-server-container?view=sql-server-ver15#restore-the-database

While I wait for my file to copy, I'm going to go ahead and test my mounting/restore setup with the file from MS.

```
sudo docker exec -it sql1 /opt/mssql-tools/bin/sqlcmd -S localhost \
   -U SA -P 'NdFe!Vtb' \
   -Q 'RESTORE FILELISTONLY FROM DISK = "/Downloads/wwi.bak"' \
   | tr -s ' ' | cut -d ' ' -f 1-2
```

well, good thing I'm testing as I get this as the output: 

<img width="915" alt="image" src="https://user-images.githubusercontent.com/7390156/169139601-8bd5a235-dfea-434c-9dab-78fdbc50e789.png">

i also noticed that i can't connect to the server running that that machine like i did the other day. hmm... ok, let's start over a little as i know i was able to run and connect to this the other day. docker is freshly instealled, so i am wipe the images, containers, and volumes. now we should be fresh.

per my documentation the other day i ran the following in powershell and was able to connect with no issues:

```
docker pull mcr.microsoft.com/azure-sql-edge
PS /Users/roy/gh/d> sudo docker run -e "ACCEPT_EULA=1" -e "MSSQL_SA_PASSWORD=NdFe!Vtb" `
>> -p 1433:1433 --name sqledge --hostname sqledge `
>> -d mcr.microsoft.com/azure-sql-edge
```

let's try and run closer to that. i can see i stuck with 1433 instead of mapping and included a hostname. let's see if adding that allows us to get moving. we'll add our volumes in as well and cross our fingers. i did *previously* download the regular sql2019 image and that was removed between these attempts. maybe there was a part of that that was supporting this image. not sure, but we'll know shortly.

<img width="581" alt="image" src="https://user-images.githubusercontent.com/7390156/169141164-f2268aa3-306c-4081-aa1d-8beb5963764c.png">

```
sudo docker run -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=NdFe!Vtb' \
   -p 1433:1433 --name sqledge --hostname sqledge \
   -v sqledgedata:/var/opt/mssql \
   -v /Users/roy/Downloads:/Downloads \
   -d mcr.microsoft.com/azure-sql-edge:latest
```

Huzzah... maybe? I also used the 'latest' image.

<img width="922" alt="image" src="https://user-images.githubusercontent.com/7390156/169141388-a9ab3752-efa7-4877-893a-09507899e9d0.png">

Apparently not. Maybe I can just connect to the machine like before?

![image](https://user-images.githubusercontent.com/7390156/169141500-ab6fc8e2-e4fd-48a7-9a88-ae4cbb3cd183.png)

yay! ðŸŽ‰

![image](https://user-images.githubusercontent.com/7390156/169141636-4a95c777-c2b2-4a81-81cf-c415fbf7b2e6.png)

double yay! ðŸŽ‰ðŸŽ‰

![image](https://user-images.githubusercontent.com/7390156/169142124-769c8a53-f07b-469c-b5cb-992f944bd47f.png)

triple yay! ðŸŽ‰ðŸŽ‰ðŸŽ‰

and finally, as expected, i can select some data. so that's nice.

![image](https://user-images.githubusercontent.com/7390156/169142370-f71a4960-956d-455b-8317-a72f58d89166.png)

I guess that sqlcmd must not be part of the m1 image. That's ok! Sadly, after about 10 hours, the copy failed because the backups ran for that night. I was concerned this might happen, but figured I would just start the copy that evening, and instead use rsync this time.

<img width="452" alt="image" src="https://user-images.githubusercontent.com/7390156/169307466-f6bfc1e6-965a-4472-ada4-0b1bd78adb59.png">

This is working, but also very slow. But should be finished with plenty of time today. I believe this same issue happened last time and due to this I ended up fiddling around on the original server..... guess what? it's starting to look like that's what's about to happen again. =)





